"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.discoverSchema = discoverSchema;
const mysql_client_1 = require("./mysql-client");
const PRODUCT_COLUMN_HINTS = [
    "product_id",
    "name",
    "model",
    "sku",
    "description",
];
const IMAGE_COLUMN_HINTS = [
    "image",
    "thumb",
    "filename",
    "product_image",
    "image_path",
];
const WEIGHTED_KEYWORDS = [
    { keyword: "product_id", weight: 3 },
    { keyword: "image", weight: 2 },
    { keyword: "description", weight: 1 },
    { keyword: "category", weight: 1 },
    { keyword: "variant", weight: 1 },
    { keyword: "option", weight: 1 },
    { keyword: "inventory", weight: 1 },
];
async function fetchRowCount(tableName) {
    try {
        const rows = await (0, mysql_client_1.runQuery)(`SELECT COUNT(*) AS count FROM \`${tableName}\` LIMIT 1`);
        return rows[0]?.count ?? undefined;
    }
    catch (error) {
        return undefined;
    }
}
function scoreTable(table) {
    const columnNames = table.columns.map((column) => column.name.toLowerCase());
    let score = 0;
    for (const hint of PRODUCT_COLUMN_HINTS) {
        if (columnNames.includes(hint)) {
            score += 2;
        }
    }
    for (const hint of IMAGE_COLUMN_HINTS) {
        if (columnNames.includes(hint)) {
            score += 1;
        }
    }
    for (const { keyword, weight } of WEIGHTED_KEYWORDS) {
        if (columnNames.some((column) => column.includes(keyword))) {
            score += weight;
        }
    }
    return score;
}
async function discoverSchema() {
    const tables = await (0, mysql_client_1.listTables)();
    const result = [];
    for (const table of tables) {
        const columns = await (0, mysql_client_1.describeTable)(table.tableName);
        const columnsInfo = columns.map((column) => ({
            name: column.Field,
            type: column.Type,
            nullable: column.Null === "YES",
            key: column.Key ?? null,
            default: column.Default ?? null,
            extra: column.Extra ?? null,
        }));
        const rowCount = await fetchRowCount(table.tableName);
        const discoverTable = {
            name: table.tableName,
            schema: table.tableSchema,
            columns: columnsInfo,
            rows: rowCount,
            candidateScore: 0,
            tags: [],
        };
        const tagSet = new Set();
        const lowerColumns = columnsInfo.map((column) => column.name.toLowerCase());
        if (lowerColumns.includes("product_id")) {
            tagSet.add("product_id");
        }
        if (lowerColumns.includes("image")) {
            tagSet.add("image");
        }
        if (lowerColumns.includes("name")) {
            tagSet.add("name");
        }
        if (table.tableName.includes("description")) {
            tagSet.add("description");
        }
        if (table.tableName.includes("category")) {
            tagSet.add("category");
        }
        discoverTable.tags = Array.from(tagSet.values());
        discoverTable.candidateScore = scoreTable(discoverTable);
        result.push(discoverTable);
    }
    const candidates = result
        .filter((table) => table.candidateScore >= 3)
        .sort((a, b) => b.candidateScore - a.candidateScore)
        .map((table) => table.name);
    return {
        tables: result,
        candidates,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlzY292ZXJ5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2V0bC9kaXNjb3ZlcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUE0REEsd0NBNERDO0FBeEhELGlEQUFxRTtBQUdyRSxNQUFNLG9CQUFvQixHQUFHO0lBQzNCLFlBQVk7SUFDWixNQUFNO0lBQ04sT0FBTztJQUNQLEtBQUs7SUFDTCxhQUFhO0NBQ2QsQ0FBQztBQUNGLE1BQU0sa0JBQWtCLEdBQUc7SUFDekIsT0FBTztJQUNQLE9BQU87SUFDUCxVQUFVO0lBQ1YsZUFBZTtJQUNmLFlBQVk7Q0FDYixDQUFDO0FBRUYsTUFBTSxpQkFBaUIsR0FBK0M7SUFDcEUsRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUU7SUFDcEMsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUU7SUFDL0IsRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUU7SUFDckMsRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUU7SUFDbEMsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUU7SUFDakMsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUU7SUFDaEMsRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUU7Q0FDcEMsQ0FBQztBQUVGLEtBQUssVUFBVSxhQUFhLENBQUMsU0FBaUI7SUFDNUMsSUFBSSxDQUFDO1FBQ0gsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFBLHVCQUFRLEVBQ3pCLG1DQUFtQyxTQUFTLFlBQVksQ0FDN0IsQ0FBQztRQUM5QixPQUFPLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLElBQUksU0FBUyxDQUFDO0lBQ3JDLENBQUM7SUFBQyxPQUFP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