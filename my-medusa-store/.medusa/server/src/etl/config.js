"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MEDUSA_URL = exports.config = void 0;
exports.adminHeaders = adminHeaders;
require("dotenv/config");
const path_1 = __importDefault(require("path"));
const paths_1 = require("./paths");
const workspaceRoot = path_1.default.resolve(__dirname, "..", "..");
const defaultDataDir = path_1.default.resolve(workspaceRoot, "..", "opencart-etl-data");
const resolveDataDir = () => {
    const configured = process.env.OPENCART_ETL_DATA_DIR?.trim();
    if (configured) {
        return path_1.default.resolve(configured);
    }
    return defaultDataDir;
};
const baseDataDir = resolveDataDir();
const ensureString = (value, fallback) => {
    if (value && value.trim()) {
        return value.trim();
    }
    return fallback;
};
const parseBoolean = (value, defaultValue = false) => {
    if (value === undefined) {
        return defaultValue;
    }
    return ["true", "1", "yes", "on"].includes(value.toLowerCase());
};
const parseNumber = (value, defaultValue) => {
    if (!value) {
        return defaultValue;
    }
    const parsed = Number(value);
    if (!Number.isFinite(parsed)) {
        return defaultValue;
    }
    return parsed;
};
exports.config = {
    mysql: {
        uri: ensureString(process.env.SOURCE_MYSQL),
        host: process.env.OC_HOST,
        port: parseNumber(process.env.OC_PORT, 3306),
        user: process.env.OC_USER,
        password: process.env.OC_PASSWORD,
        database: process.env.OC_DATABASE,
        tablePrefix: process.env.OC_TABLE_PREFIX ?? "oc_",
        languageId: parseNumber(process.env.OC_LANGUAGE_ID, 1),
        storeId: parseNumber(process.env.OC_STORE_ID, 0),
        imageBaseUrl: ensureString(process.env.OC_IMAGE_BASE_URL),
        connectionLimit: parseNumber(process.env.DB_CONNECTION_LIMIT, 5),
        readOnly: parseBoolean(process.env.OC_READ_ONLY, true),
    },
    postgres: {
        uri: ensureString(process.env.TARGET_POSTGRES),
        ssl: parseBoolean(process.env.PG_SSL, false),
    },
    storage: {
        provider: process.env.OBJECT_STORAGE_PROVIDER ?? "s3",
        bucket: ensureString(process.env.OBJECT_STORAGE_BUCKET),
        basePath: ensureString(process.env.OBJECT_STORAGE_BASE_PATH, "opencart"),
    },
    medusa: {
        adminUrl: ensureString(process.env.MEDUSA_ADMIN_API ?? process.env.MEDUSA_URL),
        token: ensureString(process.env.MEDUSA_ADMIN_TOKEN ?? process.env.MEDUSA_API_TOKEN),
        dryRun: parseBoolean(process.env.OPENCART_ETL_DRY_RUN, false),
        defaultCurrency: (process.env.MEDUSA_CURRENCY_CODE ??
            process.env.CURRENCY ??
            "inr").toLowerCase(),
        stockLocationId: ensureString(process.env.MEDUSA_LOCATION_ID),
        defaultSalesChannelId: ensureString(process.env.MEDUSA_DEFAULT_SALES_CHANNEL_ID),
    },
    api: {
        port: parseNumber(process.env.OPENCART_ETL_PORT, 7070),
        host: process.env.OPENCART_ETL_HOST ?? "0.0.0.0",
    },
    paths: {
        dataDir: paths_1.ETL_DIR,
        jobsDir: paths_1.JOBS_DIR,
        backupsDir: path_1.default.join(paths_1.ETL_DIR, "backups"),
        checkpointsDir: paths_1.CHECKPOINTS_DIR,
        reportsDir: paths_1.REPORTS_DIR,
        mappingsDir: paths_1.MAPPINGS_DIR,
        logFile: paths_1.LOG_FILE,
    },
    worker: {
        imageConcurrency: parseNumber(process.env.OPENCART_ETL_IMAGE_CONCURRENCY, 8),
        batchSize: parseNumber(process.env.OPENCART_ETL_BATCH_SIZE, 200),
        retryLimit: parseNumber(process.env.OPENCART_ETL_RETRY_LIMIT, 3),
        retryBackoffMs: parseNumber(process.env.OPENCART_ETL_RETRY_BACKOFF_MS, 1500),
    },
};
// --- Medusa admin base + auth headers (v2) ---
exports.MEDUSA_URL = process.env.MEDUSA_URL ?? "http://localhost:9000";
/** Build headers for admin requests.
 * Supports:
 *   - BASIC  : Authorization: "Basic <secret>"
 *   - API KEY: Authorization: "ApiKey <secret>"  (+ x-medusa-access-token)
 */
function adminHeaders() {
    const h = { "Content-Type": "application/json" };
    const scheme = (process.env.MEDUSA_ADMIN_AUTH_SCHEME ?? "basic").toLowerCase();
    if (scheme === "basic" && process.env.MEDUSA_ADMIN_BASIC) {
        h["Authorization"] = `Basic ${process.env.MEDUSA_ADMIN_BASIC}`;
    }
    else if (process.env.MEDUSA_ADMIN_TOKEN) {
        h["Authorization"] = `ApiKey ${process.env.MEDUSA_ADMIN_TOKEN}`;
        h["x-medusa-access-token"] = process.env.MEDUSA_ADMIN_TOKEN;
    }
    return h;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2V0bC9jb25maWcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBMElBLG9DQVlDO0FBdEpELHlCQUF1QjtBQUN2QixnREFBd0I7QUFDeEIsbUNBT2lCO0FBSWpCLE1BQU0sYUFBYSxHQUFHLGNBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztBQUUxRCxNQUFNLGNBQWMsR0FBRyxjQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxJQUFJLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztBQUU5RSxNQUFNLGNBQWMsR0FBRyxHQUFXLEVBQUU7SUFDbEMsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsRUFBRSxJQUFJLEVBQUUsQ0FBQztJQUM3RCxJQUFJLFVBQVUsRUFBRSxDQUFDO1FBQ2YsT0FBTyxjQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFDRCxPQUFPLGNBQWMsQ0FBQztBQUN4QixDQUFDLENBQUM7QUFFRixNQUFNLFdBQVcsR0FBRyxjQUFjLEVBQUUsQ0FBQztBQUVyQyxNQUFNLFlBQVksR0FBRyxDQUNuQixLQUF5QixFQUN6QixRQUFpQixFQUNHLEVBQUU7SUFDdEIsSUFBSSxLQUFLLElBQUksS0FBSyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUM7UUFDMUIsT0FBTyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDdEIsQ0FBQztJQUNELE9BQU8sUUFBUSxDQUFDO0FBQ2xCLENBQUMsQ0FBQztBQUVGLE1BQU0sWUFBWSxHQUFHLENBQUMsS0FBeUIsRUFBRSxZQUFZLEdBQUcsS0FBSyxFQUFFLEVBQUU7SUFDdkUsSUFBSSxLQUFLLEtBQUssU0FBUyxFQUFFLENBQUM7UUFDeEIsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQztJQUNE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